<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        rect {
            fill: white;
        }

        .tooltip {
            padding: 8px;
            fill: lightcoral;
            rx: 4px;
        }

        .grid path,
        .grid line {
            stroke: lightgrey;
            shape-rendering: crispEdges;
        }

        .grid path {
            stroke-width: 0;
        }

        .grid line {
            stroke-opacity: 0.7;
        }
    </style>
</head>

<body>
    <div id="ftrent"></div>
    <button id="reset-btn">reset</button>

    <script src="https://d3js.org/d3.v4.js"></script>
    <script>
        d3.csv('/24_tokwawan_cleaned.csv', function (data) {
            new ScatterPlot({
                selector: '#ftrent',
                data: data.map(d => ({ ...d, id: d.detail_url })),
                width: 980,
                height: 600,
                getX: (d) => parseInt(d.saleable_area),
                getY: (d) => parseInt(d.rent),
                resetBtnSelector: '#reset-btn',
            });
        })

        class ScatterPlot {
            constructor({
                selector,
                width: overallWidth,
                height: overallHeight,
                data,
                getX = (d) => d[0],
                getY = (d) => d[1],
                resetBtnSelector,
                pointRadius = 4,
            }) {
                this.getX = getX;
                this.getY = getY;
                this.data = data;
                this.pointRadius = pointRadius;
                this.selector = selector;
                this.tooltips = {};

                const margin = { top: 10, right: 30, bottom: 30, left: 60 };
                this.width = overallWidth -= (margin.left + margin.right);
                this.height = overallHeight -= (margin.top + margin.bottom);

                const svg = d3.select(this.selector)
                    .on("touchstart", function noZoom() {
                        d3.event.preventDefault();
                    })
                    .on("touchmove", function noZoom() {
                        d3.event.preventDefault();
                    })
                    .append("svg")
                    .attr("width", this.width + margin.left + margin.right)
                    .attr("height", this.height + margin.top + margin.bottom);

                this.g = svg.append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");

                this.g.append("rect")
                    .attr("width", this.width)
                    .attr("height", this.height)
                    .on("click", function onBackgroundClicked(d, i) {
                        if (d3.event.defaultPrevented) return; // zoomed
                        // TODO: any action here
                    });

                this.createAxis();

                this.createScatter();

                const zoom = d3.zoom().on("zoom", this.zoomed);

                this.g.call(zoom);

                if (resetBtnSelector) {
                    d3.select(resetBtnSelector).on('click', () => {
                        zoom.transform(this.g, d3.zoomIdentity);
                    });
                }
            }

            zoomed = () => {
                const transform = d3.event.transform;

                const newX = transform.rescaleX(this.x);
                const newY = transform.rescaleY(this.y);

                this.xAxis.call(d3.axisBottom(newX).ticks(5).tickSize(-this.height));
                this.yAxis.call(d3.axisLeft(newY).ticks(5).tickSize(-this.width));

                this.scatter
                    .selectAll("circle")
                    .attr('cx', (d) =>  newX(this.getX(d)))
                    .attr('cy', (d) =>  newY(this.getY(d)));

                Object.keys(this.tooltips).forEach((id) => {
                    const { tooltip , data } = this.tooltips[id];
                    tooltip
                        .attr('x', newX(this.getX(data) + this.pointRadius))
                        .attr('y', newY(this.getY(data) - 36 - this.pointRadius));
                });
            }

            createAxis = () => {
                this.x = d3.scaleLinear()
                    .domain([0, d3.max(this.data, this.getX) * 1.1])
                    .range([0, this.width]);
                this.xAxis = this.g.append("g")
                    .attr("class", "grid")
                    .attr("transform", "translate(0," + this.height + ")")
                    .call(d3.axisBottom(this.x).ticks(5).tickSize(-this.height));

                this.y = d3.scaleLinear()
                    .domain([0, d3.max(this.data, this.getY) * 1.1])
                    .range([this.height, 0]);
                this.yAxis = this.g.append("g")
                    .attr("class", "grid")
                    .call(d3.axisLeft(this.y).ticks(5).tickSize(-this.width));
            }

            createTooltip = () => {
                return this.g.append('rect')
                    .attr("class", "tooltip")
                    .attr('width', 100)
                    .attr('height', 100);
            }

            createScatter = () => {
                const self = this;

                self.g.append("defs").append("SVG:clipPath")
                    .attr("id", "clip")
                    .append("SVG:rect")
                    .attr("width", self.width)
                    .attr("height", self.height)
                    .attr("x", 0)
                    .attr("y", 0);

                self.scatter = self.g.append("g")
                    .attr("clip-path", "url(#clip)")
                    .attr("class", "scatter");

                self.scatter.selectAll("circle")
                    .data(self.data)
                    .enter().append("circle")
                    .attr("cx", (d) => self.x(self.getX(d)))
                    .attr("cy", (d) => self.y(self.getY(d)))
                    .attr("r", this.pointRadius)
                    .style("fill", "#61a3a9")
                    .style("opacity", 0.5)
                    .on("mouseover", function(d) {
                        d3.select(this).style('fill', 'red');
                    })
                    .on("mouseout", function(d) {
                        if (self.tooltips[d.id]) {
                            return;
                        }
                        d3.select(this).style('fill', '#61a3a9');
                    })
                    .on('click', function (d) {
                        const { id } = d;
                        if (self.tooltips[id]) {
                            d3.select(this).style('fill', '#61a3a9');
                            const { tooltip } = self.tooltips[id];
                            tooltip.remove();
                            delete self.tooltips[id];
                        } else {
                            d3.select(this).style('fill', 'red');

                            const tooltip = self.createTooltip();
                            self.tooltips[id] = {
                                tooltip,
                                data: d,
                            };

                            tooltip.style("opacity", .9)
                                .html(self.getX(d) + ', ' + self.getY(d))
                                .attr('x', self.x(self.getX(d) + self.pointRadius))
                                .attr('y', self.y(self.getY(d) - self.pointRadius));
                        }
                    });
            }
        }
    </script>
</body>

</html>